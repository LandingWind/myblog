<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>source map异步构建 - Melon</title><meta name="Description" content=""><meta property="og:title" content="source map异步构建" />
<meta property="og:description" content="需求背景 大型Webpack项目构建时，加入source map构建严重影响构建速度，而且容易导致运行内存不足进而导致构建失败 source map简单了解 https://segmentfault.com/a/1190000020213957" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/tech/sourcemap-async-build/" />
<meta property="article:published_time" content="2020-08-24T01:00:02+08:00" />
<meta property="article:modified_time" content="2020-08-24T01:00:02+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="source map异步构建"/>
<meta name="twitter:description" content="需求背景 大型Webpack项目构建时，加入source map构建严重影响构建速度，而且容易导致运行内存不足进而导致构建失败 source map简单了解 https://segmentfault.com/a/1190000020213957"/>
<meta name="application-name" content="Melon">
<meta name="apple-mobile-web-app-title" content="Melon"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="/tech/sourcemap-async-build/" /><link rel="prev" href="/tech/recoil-vs-hox/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "source map异步构建",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/tech\/sourcemap-async-build\/"
        },"genre": "tech","keywords": "webpack, sourcemap","wordcount":  3252 ,
        "url": "\/tech\/sourcemap-async-build\/","datePublished": "2020-08-24T01:00:02+08:00","dateModified": "2020-08-24T01:00:02+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "wkk"
            },"description": ""
    }
    </script></head>
    <body header-desktop="auto" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Melon">Melon</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/tech"> Tech </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Melon">Melon</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/tech" title="">Tech</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="page single special"><h1 class="single-title animated pulse faster">source map异步构建</h1><div class="content" id="content"><h1 id="需求背景">需求背景</h1>
<p>大型Webpack项目构建时，加入source map构建严重影响构建速度，而且容易导致运行内存不足进而导致构建失败
source map简单了解 <a href="https://segmentfault.com/a/1190000020213957" target="_blank" rel="noopener noreffer">https://segmentfault.com/a/1190000020213957</a></p>
<h1 id="目前方案">目前方案</h1>
<p>划分为两次构建，第一次构建时不加入source map构建选项，可延后的第二次构建中进行环境相同的构建，使用构建产物中的source map文件</p>
<h2 id="缺陷-和-风险">缺陷 和 风险</h2>
<ul>
<li>
<p>为保证两次构建的产物对应，我们需要采用完全相同的环境去构建</p>
</li>
<li>
<p>【重点】为了明确两次构建产物的联系，我们需要通过构建产物相同的Hash</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593413397744-f7d6be58-1e06-433e-a7f6-06ba2f887379.png#align=left&amp;display=inline&amp;height=545&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2014.10.49.png&amp;originHeight=1090&amp;originWidth=1202&amp;size=289712&amp;status=done&amp;style=shadow&amp;width=601"
        data-srcset="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593413397744-f7d6be58-1e06-433e-a7f6-06ba2f887379.png#align=left&amp;display=inline&amp;height=545&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2014.10.49.png&amp;originHeight=1090&amp;originWidth=1202&amp;size=289712&amp;status=done&amp;style=shadow&amp;width=601, https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593413397744-f7d6be58-1e06-433e-a7f6-06ba2f887379.png#align=left&amp;display=inline&amp;height=545&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2014.10.49.png&amp;originHeight=1090&amp;originWidth=1202&amp;size=289712&amp;status=done&amp;style=shadow&amp;width=601 1.5x, https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593413397744-f7d6be58-1e06-433e-a7f6-06ba2f887379.png#align=left&amp;display=inline&amp;height=545&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2014.10.49.png&amp;originHeight=1090&amp;originWidth=1202&amp;size=289712&amp;status=done&amp;style=shadow&amp;width=601 2x"
        data-sizes="auto"
        alt="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593413397744-f7d6be58-1e06-433e-a7f6-06ba2f887379.png#align=left&amp;display=inline&amp;height=545&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2014.10.49.png&amp;originHeight=1090&amp;originWidth=1202&amp;size=289712&amp;status=done&amp;style=shadow&amp;width=601"
        title="截屏2020-06-29 14.10.49.png" /></p>
<ul>
<li>
<p>影响Hash的环境因素和构建参数很多 可参考<a href="https://www.notion.so/createHash-f6ba5634b09146b7b7c0e1d5f56d3421" target="_blank" rel="noopener noreffer">分析文档</a>（根据webpack4-createHash源码得到）</p>
</li>
<li>
<p>【Bug&amp;Fix】关于一直以来的两次构建Hash不一致问题，我终于排查到是因为antd包的一个时间戳key，引发ModuleId不一致，进而引发ChunkId不一致（相关<a href="https://github.com/cnpm/npminstall/pull/329/files" target="_blank" rel="noopener noreffer">FixPR</a>）</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593420912075-f4067e71-990e-4ad9-989a-cf850fcd3c79.png#align=left&amp;display=inline&amp;height=191&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2016.54.44.png&amp;originHeight=382&amp;originWidth=1556&amp;size=102623&amp;status=done&amp;style=none&amp;width=778"
        data-srcset="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593420912075-f4067e71-990e-4ad9-989a-cf850fcd3c79.png#align=left&amp;display=inline&amp;height=191&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2016.54.44.png&amp;originHeight=382&amp;originWidth=1556&amp;size=102623&amp;status=done&amp;style=none&amp;width=778, https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593420912075-f4067e71-990e-4ad9-989a-cf850fcd3c79.png#align=left&amp;display=inline&amp;height=191&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2016.54.44.png&amp;originHeight=382&amp;originWidth=1556&amp;size=102623&amp;status=done&amp;style=none&amp;width=778 1.5x, https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593420912075-f4067e71-990e-4ad9-989a-cf850fcd3c79.png#align=left&amp;display=inline&amp;height=191&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2016.54.44.png&amp;originHeight=382&amp;originWidth=1556&amp;size=102623&amp;status=done&amp;style=none&amp;width=778 2x"
        data-sizes="auto"
        alt="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593420912075-f4067e71-990e-4ad9-989a-cf850fcd3c79.png#align=left&amp;display=inline&amp;height=191&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2016.54.44.png&amp;originHeight=382&amp;originWidth=1556&amp;size=102623&amp;status=done&amp;style=none&amp;width=778"
        title="截屏2020-06-29 16.54.44.png" /></p>
<ul>
<li>
<p>引发Hash不一致的本质问题没有解决，我们难以管控中间所有的非确定性因子，今天antd pro的Ellipsis构建用到了timestamp，明天语雀的加密可能就用到了md5+时间戳，后天说不定哪个产品构建用起了随机数&hellip;不可控是关键</p>
</li>
<li>
<p>消耗不必要的计算资源：两次构建的第二次构建，webpack打包流程中，uglify之前包括uglify本身都是无意义的，因为我们需要的只是source map文件</p>
</li>
<li>
<p>source map构建过程中的排查成本和维护成本高</p>
<ul>
<li>排查成本：source map出现问题时，一般是对应不上无法使用，由于构建环境不一致，难以排查问题</li>
<li>维护成本：如果需要更新修复的sourcemap，不能直接更新，因为无法比对验证其正确性（除非有专人肉眼识别），只能再跑两次构建</li>
</ul>
</li>
<li>
<p>source map的配置能力弱：罗列一下我觉得需要的配置</p>
<ul>
<li>配置什么chunk asset需要做source map</li>
<li>配置不同的chunk asset做不同的source map策略，比如关键文件需要知道行信息和列信息，一般文件只需要知道行信息</li>
</ul>
</li>
<li>
<p>没有cache能力：Hash一致的chunk asset不必要重复生成source map文件，而应该去集中的<strong>source map cache</strong>中调取</p>
</li>
</ul>
<h1 id="解决方案">解决方案</h1>
<h2 id="临时方案">临时方案</h2>
<p>临时方案不一定是简单的方案，但一定是缺陷相对多的方案。在debug的过程中，我大致有以下几种解决问题的临时方案思路</p>
<h3 id="监控不确定性因子">监控不确定性因子</h3>
<p>构建过程中non-determinate的因子是引发HashId改变的关键，那最直观的解决方法就是去除这些不确定因子。</p>
<h4 id="相关技术">相关技术</h4>
<p>最直观直接调用webpack提供的<a href="https://webpack.js.org/api/parser/" target="_blank" rel="noopener noreffer">Javascript Parser Hooks</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// 解析到 assigned 时判断是否为不确定性因子
</span><span class="c1"></span><span class="nx">a</span> <span class="o">+=</span> <span class="nx">b</span><span class="p">;</span>
<span class="nx">parser</span><span class="p">.</span><span class="nx">hooks</span><span class="p">.</span><span class="nx">assigned</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">).</span><span class="nx">tap</span><span class="p">(</span><span class="s1">&#39;MyPlugin&#39;</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">isDeterminate</span><span class="p">(</span><span class="nx">expression</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">notation</span><span class="p">)))</span> <span class="c1">// notation: 表达式中间的一些符号
</span><span class="c1"></span>  <span class="p">{</span>
    <span class="c1">// do something
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   	<span class="c1">// do something 
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">});</span>
<span class="c1">// 判断是否确定性
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">isDeterminate</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// 通过正则表达式判断是否携带 时间戳
</span><span class="c1"></span><span class="p">}</span>
<span class="c1">// 类似这样写几个hooks...
</span></code></pre></td></tr></table>
</div>
</div><p>另外或者从AST树介入去查找，效率低但会更可靠</p>
<blockquote>
<h3 id="program">program</h3>
<p><code>SyncBailHook</code>
Get access to the abstract syntax tree (AST) of a code fragment
Parameters: <code>ast</code> <code>comments</code></p>
</blockquote>
<p>还有可以从<a href="https://github.com/babel/babylon" target="_blank" rel="noopener noreffer">@babel-parser</a>中介入，传入解析时候的配置参数
bebel-parser还是提供了许多的个性化的解析能力 参考options源码 <a href="https://github.com/babel/babel/blob/master/packages/babel-parser/src/options.js" target="_blank" rel="noopener noreffer">https://github.com/babel/babel/blob/master/packages/babel-parser/src/options.js</a></p>
<h4 id="heading"></h4>
<h4 id="有什么问题">有什么问题？</h4>
<ul>
<li>时间戳还比较好检测，随机数怎么判断呢</li>
<li>其他可能潜在的不确定因子怎么办</li>
<li>那么多ast node对值做一个正则判断，计算资源和时间效率我想是不可以接受的</li>
<li>检测到了不确定因子修改为确定值，是否会影响业务逻辑？（加密参数的话直接崩了）又是否会影响source map列坐标的准确性？本末颠倒了</li>
</ul>
<hr>
<h3 id="比对更改产物hash">比对更改产物Hash</h3>
<p>在debug hash不一致的难捱时间里，我写过强制更改产物Hash的插件<a href="https://code.alipay.com/mike.wjk/webpack-hashCorrect-plugin" target="_blank" rel="noopener noreffer">webpack-hashCorrect-plugin</a></p>
<h4 id="主要思路">主要思路</h4>
<p>写了一个通过AST的tokens比对JavaScript代码一致性的<a href="https://github.com/wkk5194/jscode-compare" target="_blank" rel="noopener noreffer">jscode-compare</a>模块，通过这一个模块对比两次构建产物是否一致，如果一致，则直接修改对应chunk asset source map的Hash保证相同；如果不一致则抛出错误
比较的内容是什么？参考生成的ast.json <a href="https://github.com/wkk5194/jscode-compare/blob/master/test/demo-ast.json#L668" target="_blank" rel="noopener noreffer">https://github.com/wkk5194/jscode-compare/blob/master/test/demo-ast.json#L668</a></p>
<h4 id="有什么问题-1">有什么问题？</h4>
<ul>
<li>AST仅仅比对tokens列表是有局限性的，严格来讲无法保证jscode完全的一致性，保证的是逻辑的一致性，所以对source map的准确性有影响</li>
</ul>
<hr>
<h3 id="注入自己管控的createhash流程">注入自己管控的createHash流程</h3>
<p>参看webpack的createHash源码 <a href="https://github.com/webpack/webpack/blob/master/lib/Compilation.js#L2404" target="_blank" rel="noopener noreffer">https://github.com/webpack/webpack/blob/master/lib/Compilation.js#L2404</a>
构建产物加hash的目的是cache，bigfish用的一般是chunkhash或者contenthash
上面抛了hash的影响因子偏多，如果不强调hash依赖于模块调用关系的话，我们可以通过构建一套自己的createHash流程保证一致</p>
<h4 id="有什么问题-2">有什么问题？</h4>
<ul>
<li>没有模块依赖的hash变动了，单纯依赖产物内容</li>
<li>自己的hash生成规则，怎么制定，感觉十分麻烦</li>
<li>侵入webpack createHash比较困难，需要考虑webpack本身的版本迭代，毕竟不是公司自己的模块</li>
</ul>
<hr>
<h2 id="可控方案">可控方案</h2>
<p>**
**大纲思想：**两次构建 =&gt; 一次构建
临时方案大多只能解决一时的问题，或者无法全部克服当前方案的哪些缺陷和风险，原因是没有跳出两次构建这个圈子，两次构建造成的限制太大
我个人觉得两次构建是一种反直觉的方式在解决source map生成的速度慢、OOM等问题
或者说这是一种强依赖Webpack本身的方式</p>
<p>而直觉的解决方案应该是 <strong>从Webpack中提取source-map构建过程，将其异步延迟构建</strong>
总的流程应该只进行 <strong>一次构建</strong></p>
<h3 id="总体流程">总体流程</h3>
<h3 id="webpack流程图-侵入点">Webpack流程图-侵入点</h3>
<p>参考了webpack官方的sourcemap插件，侵入到_compilation-seal阶段即可，根据情况选择侵入afterOptimizeChunkAssets还是optimizeChunkAssets_
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593422100019-12e0c0eb-6874-473e-9925-c9b7766ef401.png#align=left&amp;display=inline&amp;height=1834&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2017.14.37.png&amp;originHeight=1834&amp;originWidth=1834&amp;size=958114&amp;status=done&amp;style=none&amp;width=1834"
        data-srcset="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593422100019-12e0c0eb-6874-473e-9925-c9b7766ef401.png#align=left&amp;display=inline&amp;height=1834&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2017.14.37.png&amp;originHeight=1834&amp;originWidth=1834&amp;size=958114&amp;status=done&amp;style=none&amp;width=1834, https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593422100019-12e0c0eb-6874-473e-9925-c9b7766ef401.png#align=left&amp;display=inline&amp;height=1834&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2017.14.37.png&amp;originHeight=1834&amp;originWidth=1834&amp;size=958114&amp;status=done&amp;style=none&amp;width=1834 1.5x, https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593422100019-12e0c0eb-6874-473e-9925-c9b7766ef401.png#align=left&amp;display=inline&amp;height=1834&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2017.14.37.png&amp;originHeight=1834&amp;originWidth=1834&amp;size=958114&amp;status=done&amp;style=none&amp;width=1834 2x"
        data-sizes="auto"
        alt="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/300858/1593422100019-12e0c0eb-6874-473e-9925-c9b7766ef401.png#align=left&amp;display=inline&amp;height=1834&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%88%AA%E5%B1%8F2020-06-29%2017.14.37.png&amp;originHeight=1834&amp;originWidth=1834&amp;size=958114&amp;status=done&amp;style=none&amp;width=1834"
        title="截屏2020-06-29 17.14.37.png" /></p>
<h1 id="可控方案-技术系分">可控方案-技术系分</h1>
<h2 id="case1持久化webpack-source">Case1：持久化Webpack Source</h2>
<h3 id="node方案">node方案</h3>
<p>侵入点：<em>afterOptimizeChunkAssets</em>
<em>官方的sourceMap插件的源码提供了思路</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// SourceMapDevToolPlugin.js
</span><span class="c1"></span>
<span class="c1">// 在afterOptimizeChunkAssets这个hook中添加事件
</span><span class="c1">// ...把chunk的所有file添加到files中集中处理
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">chunk</span> <span class="k">of</span> <span class="nx">chunks</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">file</span> <span class="k">of</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">files</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">matchObject</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span> <span class="p">{</span>
			<span class="nx">files</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
				<span class="nx">file</span><span class="p">,</span>
				<span class="nx">chunk</span>
			<span class="p">});</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="c1">// ...在files.foreach中
</span><span class="c1">// 获取source
</span><span class="c1">// 查阅webpack-sources https://github.com/webpack/webpack-sources
</span><span class="c1">// Source.prototype.source() -&gt; String | Buffer
</span><span class="c1">// Returns the represented source code as string or Buffer (for binary Sources).
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">asset</span> <span class="o">=</span> <span class="nx">compilation</span><span class="p">.</span><span class="nx">getAsset</span><span class="p">(</span><span class="nx">file</span><span class="p">).</span><span class="nx">source</span><span class="p">;</span> 

<span class="c1">// cache中有可能已经有sourcemap
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">assetsCache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">asset</span><span class="p">);</span>

<span class="c1">// 如果没有，就generate sourcemap
</span><span class="c1">// 创建一个task
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">task</span> <span class="o">=</span> <span class="nx">getTaskForFile</span><span class="p">(</span>
	<span class="nx">file</span><span class="p">,</span>
	<span class="nx">asset</span><span class="p">,</span>
	<span class="nx">chunk</span><span class="p">,</span>
	<span class="nx">options</span><span class="p">,</span>
	<span class="nx">compilation</span>
<span class="p">);</span>
<span class="c1">// into func getTaskForFile()
</span><span class="c1">// sourceAndMap: 可以查阅webpack-sources
</span><span class="c1">// Source.prototype.sourceAndMap(options?: Object) -&gt; {
</span><span class="c1">//	 source: String | Buffer,
</span><span class="c1">//	 map: Object
</span><span class="c1">// }
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">asset</span><span class="p">.</span><span class="nx">sourceAndMap</span><span class="p">)</span> <span class="p">{</span>
	<span class="kr">const</span> <span class="nx">sourceAndMap</span> <span class="o">=</span> <span class="nx">asset</span><span class="p">.</span><span class="nx">sourceAndMap</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
	<span class="nx">sourceMap</span> <span class="o">=</span> <span class="nx">sourceAndMap</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>
	<span class="nx">source</span> <span class="o">=</span> <span class="nx">sourceAndMap</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nx">sourceMap</span> <span class="o">=</span> <span class="nx">asset</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
	<span class="nx">source</span> <span class="o">=</span> <span class="nx">asset</span><span class="p">.</span><span class="nx">source</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// 在tasks.foreach中就生成了*.map文件
</span></code></pre></td></tr></table>
</div>
</div><p>我们对每一个asset做序列化，抛给sourcemap计算群，后面的流程是反序列化，调用source-map（其实按照官方插件的思路，直接调用webpack-sources的相应接口即可）</p>
<h3 id="esbuild方案">esbuild方案</h3>
<p>侵入点：optimizeChunkAssets
云谦老师的esbuild-webpack-plugin给了启发思路
可以跑两次esbuild，去掉缓慢的terser&hellip;一举两得</p>
<h4 id="代码展示流程">代码展示流程</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">startService</span><span class="p">,</span> <span class="nx">Service</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;esbuild&#39;</span><span class="p">;</span>
<span class="c1">// 启动esbuild service
</span><span class="c1"></span><span class="nx">service</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">startService</span><span class="p">();</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">map</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">assetSource</span><span class="p">.</span><span class="nx">sourceAndMap</span><span class="p">();</span>
<span class="c1">// 跑esbuild的minify服务
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">ESBuildPlugin</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">options</span><span class="p">,</span>
  <span class="nx">minify</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">sourcemap</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">sourcefile</span><span class="o">:</span> <span class="nx">file</span><span class="p">,</span> <span class="c1">// filename
</span><span class="c1"></span><span class="p">});</span>
<span class="c1">// update emit asset
</span><span class="c1"></span>
<span class="c1">// 序列化 source,map
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">outputPath</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
<span class="nx">serialize</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">sourceOutputPath</span><span class="p">)</span>
<span class="nx">serialize</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">mapOutputPath</span><span class="p">)</span>
<span class="c1">// 抛给sourcemap计算集群
</span><span class="c1"></span>
<span class="o">---</span>
<span class="c1">// sourcemap计算函数中
</span><span class="c1">// 反序列化
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">deserialize</span><span class="p">(</span><span class="nx">sourceOutputPath</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">deserialize</span><span class="p">(</span><span class="nx">mapOutputPath</span><span class="p">)</span>
<span class="c1">// 跑esbuild的minify+sourcemap服务
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">ESBuildPlugin</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">options</span><span class="p">,</span>
  <span class="nx">minify</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">sourcemap</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">devtool</span><span class="p">,</span>
  <span class="nx">sourcefile</span><span class="o">:</span> <span class="nx">file</span><span class="p">,</span> <span class="c1">// filename
</span><span class="c1"></span><span class="p">});</span>
<span class="c1">// 抛给sourcemap CDN
</span><span class="c1"></span><span class="nx">putCDN</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">jsSourceMap</span><span class="p">)</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="case2持久化ast">Case2：持久化AST</h2>
<p>case1方案中调用source-map库的Consumer生成AST，持久化AST，抛给Sourcemap计算群
接下来可以选择Node方案或者Rust方案</p>
</div></div></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by Hugo | Theme is LoveIt
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/landingwind" target="_blank">wkk</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
